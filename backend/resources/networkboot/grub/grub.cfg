# Server configuration
HTTP_SERVER=http://${net_default_dhcp_server_name}

# Env-Variables
HTTP_ROOT=https://${net_default_dhcp_server_name}/static
THEME_FOLDER=/grub/themes/
CONFIG_FOLDER=/grub/config/

# Load theme
set theme=$THEME_FOLDER/base/autotheme.txt

# Initialize environment
terminal_output gfxterm
set gfxmode=auto
set gfxpayload=keep

# Key bindings
bind_key 0x20 manual_selection  # Space
bind_key 0x1b local_boot        # ESC

# Function to load manual selection menu
function manual_selection {
    set timeout=-1
    configfile CONFIG_FOLDER/main.cfg
}

# Function to boot local OS
function local_boot {
    set timeout=-1
    set root=(hd0,0)
    chainloader +1
    boot
}

# Function to notify server and store response ID
function notify_server {
    # Initialize global variable for storing the ID
    set server_response_id=''
    
    # Make HTTP request and capture response into server_response_id
    regexp "id=([^&]+)" (http_get ${HTTP_SERVER}/jobs/notify?clientMac=${net_default_mac}&clientIp=${net_default_ip}&clientPlatform=${grub_platform}) server_response_id
    
    # Return the ID for use in other functions
    return $server_response_id
}

# Main menu
menuentry "Waiting for server..." --class loading {
    # Call notify_server and store ID
    notify_server

    # Poll for new configuration using stored ID
    if [ -n "$server_response_id" ]; then
        if [ -f (http)/${HTTP_SERVER}/api/jobs/${server_response_id}/config ]; then
            configfile (http)/${HTTP_SERVER}/api/jobs/${server_response_id}/config
        fi
    fi

    sleep 15
    configfile /grub/config/grub.cfg
}

menuentry "Manual Selection" --class tools {
    manual_selection
}

menuentry "Boot Local System" --class windows {
    local_boot
}

menuentry 'EFI Firmware System Setup' $menuentry_id_option 'uefi-firmware' {
    fwsetup
}

menuentry 'Reboot' --class restart {
    reboot
}

menuentry 'Shutdown' --class shutdown {
    halt
}

# Set timeout and default entry
set timeout=15
set default=0